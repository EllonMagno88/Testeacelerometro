<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Controle Mouse via Wi-Fi</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Permissions-Policy" content="accelerometer=*, gyroscope=*">
<meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' ws: wss: http: https: data: blob:;">

<style>
  body { font-family: system-ui, Arial, sans-serif; margin: 0; padding: 0; background: #f2f2f2; color: #222; }
  .container { display: flex; flex-direction: column; align-items: center; padding: 12px; max-width: 500px; margin: auto; }
  h1 { margin-top: 10px; font-size: 1.4rem; color: #054; text-align: center; }
  #status { margin: 8px 0; padding: 8px; border-radius: 8px; background: #a00; color: #fff; font-weight: bold; text-align: center; width: 100%; }
  input, button { padding: 10px; margin: 5px; width: 100%; border-radius: 8px; border: 1px solid #ccc; font-size: 1rem; }
  button { cursor: pointer; background: #0b5; color: white; font-weight: 600; }
  button:hover { background: #098; }
  hr { width: 100%; margin: 12px 0; border: 0; border-top: 1px solid #ccc; }
  #pad { width: 100%; height: 250px; border-radius: 12px; border: 2px solid #ccc; background: #fff; display: flex; align-items: center; justify-content: center; color: #555; user-select: none; touch-action: none; margin-top: 10px; }
  .btns { display: flex; gap: 8px; width: 100%; justify-content: space-between; margin-top: 12px; }
  #keyboard { display: flex; width: 100%; gap: 8px; margin-top: 10px; }
  #keyboard input { flex: 1; }
  #toggleMode { width: 100%; background: #444; color: white; }
  #toggleMode.active { background: #e09f1f; }
  #sessionTimer { margin-top: 6px; font-size: 1rem; font-weight: bold; color: #054; background: #d7ffd7; padding: 6px 10px; border-radius: 8px; display: none; width: 100%; text-align: center; }
  #usageStats { margin-top: 10px; padding: 10px; background: #eef; border-radius: 8px; display: none; }
  #cursor-indicator { position: fixed; width: 14px; height: 14px; background: rgba(0, 150, 255, 0.9); border-radius: 50%; pointer-events: none; transform: translate(-50%, -50%); transition: transform 0.05s linear; z-index: 9999; }
  #click-effect { position: fixed; width: 20px; height: 20px; border: 2px solid rgba(255, 255, 255, 0.8); border-radius: 50%; pointer-events: none; opacity: 0; transform: translate(-50%, -50%) scale(0.2); transition: opacity 0.2s, transform 0.2s; z-index: 9998; }
  #force-meter { position: fixed; right: 15px; bottom: 20px; width: 12px; height: 120px; background: rgba(255, 255, 255, 0.15); border-radius: 10px; overflow: hidden; z-index: 9999; }
  #force-fill { width: 100%; height: 0%; background: rgba(0, 200, 0, 0.9); transition: height 0.08s linear; }
  #macroPanel {width: 100%;
  padding: 15px;
  background: #1e1e1e;
  display: none;
  flex-direction: column;
  gap: 10px;
  border-top: 2px solid #444;}
</style>
</head>

<body>
  <div class="container">
    <h1>Mouse Pointer</h1>
    <div id="status">Desconectado</div>
    <div id="sessionTimer">
‚è± Tempo de sess√£o: 00:00:00
    </div>
    <div id="usageStats">

  <h3>üìä Estat√≠sticas de Uso</h3>
  <p>Movimentos enviados: <span id="statMoves">0</span></p>
  <p>Dist√¢ncia percorrida: <span id="statDist">0</span> px</p>
  <p>Teclas enviadas: <span id="statKeys">0</span></p>
  <p>Cliques enviados: <span id="statClicks">0</span></p>
  <p>Modo usado mais vezes: <span id="statMode">touchpad</span></p>
  
    </div>



    <input type="text" id="wsUrl" placeholder="ws://192.168.x.x:8765" value="ws://192.168.0.100:8765">
    <input type="password" id="token" placeholder="Token" value="1234">
    <button id="connectBtn">Conectar</button>
    <button id="disconnectBtn">Desconectar</button>

    <hr>

    <button id="toggleMode">Ativar controle por movimento</button>

    <div id="pad">Toque aqui para mover o mouse</div>

    <div class="btns">
      <button id="leftBtn">üñ±Ô∏è Clique Esquerdo</button>
      <button id="rightBtn">üñ±Ô∏è Clique Direito</button>
      <button id="kbBtn">‚å®Ô∏è Teclado</button>
    </div>

    <div id="profileSettings" class="box">
    <h2>üéöÔ∏è Sensibilidade & Perfis</h2>

    <label>Sensibilidade do Aceler√¥metro</label>
    <input id="accelFactor" type="range" min="1" max="10" step="0.1">

    <label>Sensibilidade do Girosc√≥pio</label>
    <input id="gyroFactor" type="range" min="0.5" max="10" step="0.1">

    <label>Zona Morta (Deadzone)</label>
    <input id="minDelta" type="range" min="0" max="2" step="0.01">

    <label>Velocidade Geral do Cursor</label>
    <input id="cursorSpeed" type="range" min="0.2" max="3" step="0.1">

    <label>Suaviza√ß√£o</label>
    <input id="smoothing" type="range" min="0" max="1" step="0.05">

    <hr>
    <input id="profileName" placeholder="Nome do perfil">
    <button id="saveProfileBtn">Salvar Perfil</button>

    <select id="profileList"></select>
    <button id="loadProfileBtn">Carregar Perfil</button>
</div>

    <!-- Indicador da posi√ß√£o do cursor -->
  <div id="cursor-indicator"></div>

  <!-- Anima√ß√£o de clique -->
  <div id="click-effect"></div>

  <!-- Indicador de for√ßa -->
  <div id="force-meter">
    <div id="force-fill"></div>
  </div>

  <!-- PAINEL DE MACROS -->
<div id="macroPanel">
  
  <h3 style="text-align:center; color:red">‚ö° Macros e Atalhos R√°pidos</h3>

  <div style="display:flex; flex-direction:column; gap:8px;">
    <input id="macroName" placeholder="Nome da macro" style="width:100%; padding:10px;">
    <input id="macroKeys" placeholder="Teclas (ex: CTRL+SHIFT+ESC)" style="width:100%; padding:10px;">
    <button id="saveMacroBtn">Salvar</button>
</div>

  <div id="macroList"></div>
</div>

  <button id="toggleMacroPanel" style="width: 100%;margin-top: 10px;">‚ö° Macros</button>


    <div id="keyboard" style="display:none;">
      <input type="text" id="textToType" placeholder="Digite algo...">
      <button id="sendText">Enviar</button>
    </div>
  </div>

<script>
(function(){
  let ws = null;
  let isConnected = false;
  let lastTouch = null;
  let lastSingleTap = 0;
  let isScrolling = false;
  let sensitivity = 1.0;
  let gyroEnabled = false;
  let moved = false;

  // --- Sensores ---
  let accelListener = null;
  let gyroListener = null;
  let lastAX = null;
  let lastAY = null;

  // Ajustes finos
  let accelFactor = 4.5;
  let minDelta = 0.08;
  let gyroFactor = 2.0;
  let smoothing = 0.3;

  // ---------- FEEDBACK VISUAL ----------
  const cursorIndicator = document.getElementById("cursor-indicator");
  const clickEffect = document.getElementById("click-effect");
  const forceFill = document.getElementById("force-fill");

  let cursorX = 0, cursorY = 0;

  function updateCursor(dx, dy){
    cursorX += dx * 1.2;
    cursorY += dy * 1.2;

    cursorIndicator.style.transform =
      `translate(${cursorX}px, ${cursorY}px)`;
  }

  function showClickEffect(){
    clickEffect.style.opacity = "1";
    clickEffect.style.transform = "scale(1)";
    setTimeout(()=>{
      clickEffect.style.opacity = "0";
      clickEffect.style.transform = "scale(0.2)";
    }, 150);
  }

  function updateForceMeter(dx, dy){
    const force = Math.min(1, Math.sqrt(dx*dx + dy*dy) / 25);
    forceFill.style.height = (force * 100) + "%";
  }

  // ---------- ESTAT√çSTICAS ----------
  const stats = {
    pointerMoves: 0,
    pointerDistance: 0,
    lastX: null,
    lastY: null,
    keysSent: 0,
    clicksSent: 0,
    modeUsage: { touchpad: 0, movement: 0 },
    currentMode: "touchpad"
  };

  function resetStats(){
    stats.pointerMoves = 0;
    stats.pointerDistance = 0;
    stats.lastX = null;
    stats.lastY = null;
    stats.keysSent = 0;
    stats.clicksSent = 0;
    stats.modeUsage.touchpad = 0;
    stats.modeUsage.movement = 0;
    stats.currentMode = "touchpad";
  }

  function setMode(mode){
    if(!isConnected) return;
    stats.currentMode = mode;
    stats.modeUsage[mode]++;
  }

  function registerPointerMovement(dx, dy){
    if(!isConnected) return;

    stats.pointerMoves++;

    if(stats.lastX !== null){
      stats.pointerDistance += Math.sqrt(dx*dx + dy*dy);
    }

    stats.lastX = dx;
    stats.lastY = dy;

    updateCursor(dx, dy);
    updateForceMeter(dx, dy);
  }

  function registerClick(){
    if(!isConnected) return;
    stats.clicksSent++;
    showClickEffect();
  }

  function registerKey(){
    if(!isConnected) return;
    stats.keysSent++;
  }

  setInterval(() => {
    document.getElementById("usageStats").style.display = "block";

    document.getElementById("statMoves").textContent = stats.pointerMoves;
    document.getElementById("statDist").textContent = Math.round(stats.pointerDistance);
    document.getElementById("statKeys").textContent = stats.keysSent;
    document.getElementById("statClicks").textContent = stats.clicksSent;

    document.getElementById("statMode").textContent =
      stats.modeUsage.touchpad > stats.modeUsage.movement
      ? "touchpad"
      : "movimento";

  }, 500);

  // ----------------------------------

  const statusEl = document.getElementById('status');
  const wsUrlInput = document.getElementById('wsUrl');
  const tokenInput = document.getElementById('token');
  const connectBtn = document.getElementById('connectBtn');
  const disconnectBtn = document.getElementById('disconnectBtn');
  const pad = document.getElementById('pad');
  const leftBtn = document.getElementById('leftBtn');
  const rightBtn = document.getElementById('rightBtn');
  const kbBtn = document.getElementById('kbBtn');
  const keyboardDiv = document.getElementById('keyboard');
  const textToType = document.getElementById('textToType');
  const sendText = document.getElementById('sendText');
  const toggleMode = document.getElementById('toggleMode');

  function setStatus(s,color='#0b5'){
    statusEl.textContent = s;
    statusEl.style.background = color;
  }

  function connect(){
    const url = wsUrlInput.value.trim();
    const token = tokenInput.value.trim();
    if(!url || !token) return alert("Informe endere√ßo e token!");

    ws = new WebSocket(url);

    ws.onopen = () => {
      ws.send(JSON.stringify({type:"auth", token}));
      setStatus("Conectado a " + url, "#054");
    };

    ws.onclose = () => {
      isConnected = false;
      disableMotion();
      setStatus("Desconectado", "#a00");
    };

    ws.onerror = () => setStatus("Erro de conex√£o", "#a00");

    ws.onmessage = msg => {
      try{
        const data = JSON.parse(msg.data);

        if(data.type==='auth' && data.status==='ok'){
          isConnected = true;
          resetStats();
          setStatus("Autenticado ‚úî", "#0a4");
          document.getElementById("sessionTimer").style.display = "block";
          return;
        }

        if(data.type==='auth'){
          setStatus("Token inv√°lido ‚ùå", "#a00");
          ws.close();
          return;
        }

        if(data.type === "session_time"){
          const sec = Math.floor(data.seconds);
          const h = String(Math.floor(sec / 3600)).padStart(2,"0");
          const m = String(Math.floor((sec % 3600) / 60)).padStart(2,"0");
          const s = String(sec % 60).padStart(2,"0");

          document.getElementById("sessionTimer").textContent =
            `‚è± Tempo de sess√£o: ${h}:${m}:${s}`;
        }

      }catch(e){
        console.error("Erro ao processar mensagem:", e);
      }
    };
  }

  function disconnect(){
    if(ws){
      try{
        if(ws.readyState===WebSocket.OPEN)
          ws.send(JSON.stringify({type:"disconnect"}));
      }catch(e){}

      disableMotion();
      ws.close();
    }

    isConnected = false;
    setStatus("Desconectado","#a00");
  }

  connectBtn.addEventListener('click', connect);
  disconnectBtn.addEventListener('click', disconnect);

  function send(obj){
    if(!isConnected) return;
    ws.send(JSON.stringify(obj));
  }

  // ============================================================
  // ACELER√îMETRO + GIROSC√ìPIO
  // ============================================================
  async function enableMotion(){
    if(gyroEnabled) return;
    if(!isConnected) return alert("Conecte-se primeiro!");

    try{
      if(typeof DeviceMotionEvent.requestPermission==="function"){
        const perm = await DeviceMotionEvent.requestPermission();
        if(perm!=="granted"){ alert("Permiss√£o negada"); return; }
      }
      if(typeof DeviceOrientationEvent.requestPermission==="function"){
        const perm = await DeviceOrientationEvent.requestPermission();
        if(perm!=="granted"){ alert("Permiss√£o girosc√≥pio negada"); return; }
      }
    }catch(e){
      alert("Erro ao solicitar permiss√£o.");
      console.error(e);
      return;
    }

    startSensors();
  }

  function startSensors(){
    gyroEnabled=true;
    setMode("movement");

    toggleMode.classList.add("active");
    toggleMode.textContent="Desativar controle por movimento";
    pad.style.opacity="0.5";

    lastAX=null;
    lastAY=null;

    accelListener = e=>{
      if(!gyroEnabled || !isConnected) return;

      const acc = e.accelerationIncludingGravity;
      if(!acc) return;

      const ax = acc.x, ay = acc.y;
      if(lastAX!==null){
        let dx = ax - lastAX;
        let dy = ay - lastAY;

        if(Math.abs(dx)<minDelta) dx=0;
        if(Math.abs(dy)<minDelta) dy=0;

        if(dx!==0 || dy!==0){
          dx*=accelFactor;
          dy*=accelFactor;

          registerPointerMovement(dx, dy);
          send({type:"gyro", dx, dy});
        }
      }
      lastAX=ax; 
      lastAY=ay;
    };

    window.addEventListener("devicemotion", accelListener);

    gyroListener = e=>{
      if(!gyroEnabled || !isConnected) return;

      const dx = (e.gamma || 0) * gyroFactor;
      const dy = (e.beta || 0) * gyroFactor;

      registerPointerMovement(dx, dy);
      send({type:"gyro", dx, dy});
    };

    window.addEventListener("deviceorientation", gyroListener);

    console.log("Sensores ativados");
  }

  function disableMotion(){
    gyroEnabled=false;

    toggleMode.classList.remove("active");
    toggleMode.textContent="Ativar controle por movimento";
    pad.style.opacity="1";

    setMode("touchpad");

    if(accelListener) window.removeEventListener("devicemotion", accelListener);
    if(gyroListener) window.removeEventListener("deviceorientation", gyroListener);

    console.log("Sensores desativados");
  }

  toggleMode.addEventListener('click', ()=>{
    if(!isConnected){
      alert("Conecte-se primeiro");
      return;
    }
    if(gyroEnabled) disableMotion(); else enableMotion();
  });

  // ============================================================
  // TOUCHPAD
  // ============================================================
  pad.addEventListener('touchstart', e=>{
    if(gyroEnabled) return;
    if(!isConnected) return;

    setMode("touchpad");

    e.preventDefault();
    moved=false;
    const t=e.touches[0];
    lastTouch={x:t.clientX,y:t.clientY};
    isScrolling=e.touches.length>=2;
  }, {passive:false});

  pad.addEventListener('touchmove', e=>{
    if(gyroEnabled) return;
    if(!isConnected) return;

    e.preventDefault();
    moved=true;

    const touches=e.touches;

    if(isScrolling && touches.length>=2){
      const cx=(touches[0].clientX+touches[1].clientX)/2;
      const cy=(touches[0].clientY+touches[1].clientY)/2;
      const dy=cy-lastTouch.y;
      lastTouch={x:cx,y:cy};

      send({type:"scroll", dx:0, dy:-Math.round(dy*0.2)});
      return;
    }

    const t=touches[0];
    const dx=t.clientX-lastTouch.x;
    const dy=t.clientY-lastTouch.y;

    lastTouch={x:t.clientX,y:t.clientY};

    registerPointerMovement(dx, dy);
    send({type:'move', dx:Math.round(dx), dy:Math.round(dy), sensitivity});
  }, {passive:false});

  pad.addEventListener('touchend', e=>{
    if(gyroEnabled) return;
    if(!isConnected) return;

    e.preventDefault();

    if(moved) return;

    const now=Date.now();
    if(now-lastSingleTap<300){
      registerClick();
      send({type:'click', button:'left', clicks:2});
      lastSingleTap=0;
    } else{
      registerClick();
      send({type:'click', button:'left', clicks:1});
      lastSingleTap=now;
    }
  }, {passive:false});

  leftBtn.addEventListener('click', ()=>{
    if(!isConnected) return;
    registerClick();
    send({type:'click', button:'left'});
  });

  rightBtn.addEventListener('click', ()=>{
    if(!isConnected) return;
    registerClick();
    send({type:'click', button:'right'});
  });

  kbBtn.addEventListener('click', ()=>{
    const v=keyboardDiv.style.display==='flex';
    keyboardDiv.style.display=v?'none':'flex';
    if(!v) setTimeout(()=> textToType.focus(), 120);
  });

  sendText.addEventListener('click', ()=>{
    if(!isConnected) return;

    const txt=textToType.value;
    if(!txt) return;

    registerKey();
    send({type:'type', text:txt});
    textToType.value='';
  });

  // ============================================================
  // PERFIS DE SENSIBILIDADE
  // ============================================================

  let currentProfile = {
    name: "Padr√£o",
    accelFactor: 4.5,
    gyroFactor: 2.0,
    minDelta: 0.08,
    cursorSpeed: 1.0,
    smoothing: 0.3
  };

  function applyProfile(p){
    accelFactor = p.accelFactor;
    gyroFactor = p.gyroFactor;
    minDelta = p.minDelta;
    sensitivity = p.cursorSpeed;
    smoothing = p.smoothing;

    document.getElementById("accelFactor").value = p.accelFactor;
    document.getElementById("gyroFactor").value = p.gyroFactor;
    document.getElementById("minDelta").value = p.minDelta;
    document.getElementById("cursorSpeed").value = p.cursorSpeed;
    document.getElementById("smoothing").value = p.smoothing;
  }

  function loadProfileList(){
    const list = document.getElementById("profileList");
    const profiles = JSON.parse(localStorage.getItem("wsProfiles") || "[]");

    list.innerHTML = "";
    profiles.forEach(p=>{
      const opt = document.createElement("option");
      opt.value = p.name;
      opt.textContent = p.name;
      list.appendChild(opt);
    });
  }

  function saveProfile(){
    const name = document.getElementById("profileName").value.trim();
    if(!name) return alert("D√™ um nome para o perfil!");

    const newProfile = {
      name,
      accelFactor: Number(document.getElementById("accelFactor").value),
      gyroFactor: Number(document.getElementById("gyroFactor").value),
      minDelta: Number(document.getElementById("minDelta").value),
      cursorSpeed: Number(document.getElementById("cursorSpeed").value),
      smoothing: Number(document.getElementById("smoothing").value)
    };

    let profiles = JSON.parse(localStorage.getItem("wsProfiles") || "[]");

    profiles = profiles.filter(p => p.name !== name);
    profiles.push(newProfile);

    localStorage.setItem("wsProfiles", JSON.stringify(profiles));

    loadProfileList();
    alert("Perfil salvo!");
  }

  function loadProfile(){
    const name = document.getElementById("profileList").value;
    if(!name) return;

    const profiles = JSON.parse(localStorage.getItem("wsProfiles") || "[]");
    const p = profiles.find(p=>p.name===name);
    if(p){
      currentProfile = p;
      applyProfile(p);
    }
  }

  document.getElementById("accelFactor").addEventListener("input", e=>{
    accelFactor = Number(e.target.value);
  });
  document.getElementById("gyroFactor").addEventListener("input", e=>{
    gyroFactor = Number(e.target.value);
  });
  document.getElementById("minDelta").addEventListener("input", e=>{
    minDelta = Number(e.target.value);
  });
  document.getElementById("cursorSpeed").addEventListener("input", e=>{
    sensitivity = Number(e.target.value);
  });
  document.getElementById("smoothing").addEventListener("input", e=>{
    smoothing = Number(e.target.value);
  });

  document.getElementById("saveProfileBtn").addEventListener("click", saveProfile);
  document.getElementById("loadProfileBtn").addEventListener("click", loadProfile);

  applyProfile(currentProfile);
  loadProfileList();

  // ============================================================
// MACROS PERSONALIZADAS
// ============================================================

function loadMacros(){
  const macros = JSON.parse(localStorage.getItem("wsMacros") || "[]");
  const list = document.getElementById("macroList");

  list.innerHTML = "";

  macros.forEach(macro => {
    const div = document.createElement("div");
    div.style.display = "flex";
    div.style.gap = "10px";
    div.style.marginBottom = "8px";
    div.style.background = "#2a2a2a";
    div.style.padding = "6px";
    div.style.borderRadius = "6px";

    div.innerHTML = `
      <b style="flex:1;">${macro.name}</b>
      <span style="flex:2;">${macro.keys.join(" + ")}</span>
    `;

    const sendBtn = document.createElement("button");
    sendBtn.textContent = "Enviar";
    sendBtn.onclick = () => {
      if(!isConnected) return alert("Conecte-se ao servidor primeiro!");
      send({ type:"macro", keys: macro.keys });
    };

    const delBtn = document.createElement("button");
    delBtn.textContent = "X";
    delBtn.style.background = "#a00";
    delBtn.onclick = () => {
      deleteMacro(macro.name);
    };

    div.appendChild(sendBtn);
    div.appendChild(delBtn);
    list.appendChild(div);
  });
}

function deleteMacro(name){
  let macros = JSON.parse(localStorage.getItem("wsMacros") || "[]");
  macros = macros.filter(m => m.name !== name);
  localStorage.setItem("wsMacros", JSON.stringify(macros));
  loadMacros();
}

function saveMacro(){
  const name = document.getElementById("macroName").value.trim();
  const keysRaw = document.getElementById("macroKeys").value.trim();

  if(!name) return alert("D√™ um nome √† macro!");
  if(!keysRaw) return alert("Digite as teclas!");

  const keys = keysRaw
    .split("+")
    .map(k => k.trim().toUpperCase())
    .filter(k => k.length > 0);

  if(keys.length === 0) return alert("Nenhuma tecla v√°lida!");

  let macros = JSON.parse(localStorage.getItem("wsMacros") || "[]");

  // substituir macro se j√° existir
  macros = macros.filter(m => m.name !== name);
  macros.push({ name, keys });

  localStorage.setItem("wsMacros", JSON.stringify(macros));

  loadMacros();
  alert("Macro salva!");
}

document.getElementById("saveMacroBtn").addEventListener("click", saveMacro);

document.getElementById("toggleMacroPanel").addEventListener("click", () => {
  const panel = document.getElementById("macroPanel");
  panel.style.display = panel.style.display === "flex" ? "none" : "flex";
});

// carrega ao abrir app
loadMacros();


})();
</script>




</body>
</html>
