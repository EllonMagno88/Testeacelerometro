<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Controle Mouse via Wi-Fi</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Permissions-Policy" content="accelerometer=*, gyroscope=*">
<meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' ws: wss: http: https: data: blob:;">

<style>
  body { font-family: system-ui, Arial, sans-serif; margin: 0; padding: 0; background: #f2f2f2; color: #222; }
  .container { display: flex; flex-direction: column; align-items: center; padding: 12px; max-width: 500px; margin: auto; }
  h1 { margin-top: 10px; font-size: 1.4rem; color: #054; text-align: center; }
  #status { margin: 8px 0; padding: 8px; border-radius: 8px; background: #a00; color: #fff; font-weight: bold; text-align: center; width: 100%; }
  input, button { padding: 10px; margin: 5px; width: 100%; border-radius: 8px; border: 1px solid #ccc; font-size: 1rem; }
  button { cursor: pointer; background: #0b5; color: white; font-weight: 600; }
  button:hover { background: #098; }
  hr { width: 100%; margin: 12px 0; border: 0; border-top: 1px solid #ccc; }
  #pad { width: 100%; height: 250px; border-radius: 12px; border: 2px solid #ccc; background: #fff; display: flex; align-items: center; justify-content: center; color: #555; user-select: none; touch-action: none; margin-top: 10px; }
  .btns { display: flex; gap: 8px; width: 100%; justify-content: space-between; margin-top: 12px; }
  #keyboard { display: flex; width: 100%; gap: 8px; margin-top: 10px; }
  #keyboard input { flex: 1; }
  #toggleMode { width: 100%; background: #444; color: white; }
  #toggleMode.active { background: #e09f1f; }
</style>
</head>

<body>
  <div class="container">
    <h1>Mouse Pointer</h1>
    <div id="status">Desconectado</div>

    <input type="text" id="wsUrl" placeholder="ws://192.168.x.x:8765" value="ws://192.168.0.100:8765">
    <input type="password" id="token" placeholder="Token" value="1234">
    <button id="connectBtn">Conectar</button>
    <button id="disconnectBtn">Desconectar</button>

    <hr>

    <button id="toggleMode">Ativar controle por movimento</button>

    <div id="pad">Toque aqui para mover o mouse</div>

    <div class="btns">
      <button id="leftBtn">üñ±Ô∏è Clique Esquerdo</button>
      <button id="rightBtn">üñ±Ô∏è Clique Direito</button>
      <button id="kbBtn">‚å®Ô∏è Teclado</button>
    </div>

    <div id="keyboard" style="display:none;">
      <input type="text" id="textToType" placeholder="Digite algo...">
      <button id="sendText">Enviar</button>
    </div>
  </div>

<script>
// Vers√£o com filtros, m√©dia m√≥vel e redu√ß√£o de ru√≠do
(function(){
  let ws = null;
  let gyroEnabled = false;
  let accelListener = null;

  // ====== Controle de suaviza√ß√£o ======
  const accelFactor = 6.0;
  const minDelta = 0.03;            // Zona morta menor
  const smoothFactor = 0.15;        // Filtro passa‚Äëbaixa
  const velocityDamp = 0.92;        // Amortecimento

  let smoothAX = 0, smoothAY = 0;
  let velX = 0, velY = 0;

  function send(obj){
    if(!ws || ws.readyState !== WebSocket.OPEN) return;
    ws.send(JSON.stringify(obj));
  }

  // ====== Ativar sensores ======
  async function enableMotion(){
    if(gyroEnabled) return;

    if(typeof DeviceMotionEvent.requestPermission === "function"){
      try{
        const perm = await DeviceMotionEvent.requestPermission();
        if(perm !== "granted"){
          alert("Permiss√£o negada");
          return;
        }
      }catch(err){
        alert("Erro ao solicitar permiss√£o");
        return;
      }
    }

    startAccelerometer();
  }

  // ====== Processamento do aceler√¥metro com filtros ======
  function startAccelerometer(){
    gyroEnabled = true;

    accelListener = e =>{
      if(!gyroEnabled) return;
      if(!e.accelerationIncludingGravity) return;

      let ax = e.accelerationIncludingGravity.x;
      let ay = e.accelerationIncludingGravity.y;

      // 1) Filtro passa‚Äëbaixa (suaviza ru√≠do)
      smoothAX = smoothAX + (ax - smoothAX) * smoothFactor;
      smoothAY = smoothAY + (ay - smoothAY) * smoothFactor;

      // 2) Derivar movimento
      let dx = ax - smoothAX;
      let dy = ay - smoothAY;

      // 3) Zona morta adaptativa
      if(Math.abs(dx) < minDelta) dx = 0;
      if(Math.abs(dy) < minDelta) dy = 0;

      // 4) Amortecimento (remove tremidas)
      velX = velX * velocityDamp + dx;
      velY = velY * velocityDamp + dy;

      const mvX = velX * accelFactor;
      const mvY = velY * accelFactor;

      if(Math.abs(mvX) < 0.01 && Math.abs(mvY) < 0.01) return;

      // 5) Envio ao PC
      send({ type: "gyro", dx: mvX, dy: mvY });
    };

    window.addEventListener("devicemotion", accelListener);
  }

  // ====== Desativar ======
  function disableMotion(){
    gyroEnabled = false;
    if(accelListener)
      window.removeEventListener("devicemotion", accelListener);
  }

  // Expondo fun√ß√µes para voc√™ usar no HTML
  window.enableMotion = enableMotion;
  window.disableMotion = disableMotion;

})();
</script>


</body>
</html>
