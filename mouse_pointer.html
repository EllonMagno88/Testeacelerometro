<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Controle Mouse via Wi-Fi</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Permissions-Policy" content="accelerometer=*, gyroscope=*">
<meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' ws: wss: http: https: data: blob:;">

<style>
  body { font-family: system-ui, Arial, sans-serif; margin: 0; padding: 0; background: #f2f2f2; color: #222; }
  .container { display: flex; flex-direction: column; align-items: center; padding: 12px; max-width: 500px; margin: auto; }
  h1 { margin-top: 10px; font-size: 1.4rem; color: #054; text-align: center; }
  #status { margin: 8px 0; padding: 8px; border-radius: 8px; background: #a00; color: #fff; font-weight: bold; text-align: center; width: 100%; }
  input, button { padding: 10px; margin: 5px; width: 100%; border-radius: 8px; border: 1px solid #ccc; font-size: 1rem; }
  button { cursor: pointer; background: #0b5; color: white; font-weight: 600; }
  button:hover { background: #098; }
  hr { width: 100%; margin: 12px 0; border: 0; border-top: 1px solid #ccc; }
  #pad { width: 100%; height: 250px; border-radius: 12px; border: 2px solid #ccc; background: #fff; display: flex; align-items: center; justify-content: center; color: #555; user-select: none; touch-action: none; margin-top: 10px; }
  .btns { display: flex; gap: 8px; width: 100%; justify-content: space-between; margin-top: 12px; }
  #keyboard { display: flex; width: 100%; gap: 8px; margin-top: 10px; }
  #keyboard input { flex: 1; }
  #toggleMode { width: 100%; background: #444; color: white; }
  #toggleMode.active { background: #e09f1f; }
</style>
</head>

<body>
  <div class="container">
    <h1>Mouse Pointer</h1>
    <div id="status">Desconectado</div>

    <input type="text" id="wsUrl" placeholder="ws://192.168.x.x:8765" value="ws://192.168.0.100:8765">
    <input type="password" id="token" placeholder="Token" value="1234">
    <button id="connectBtn">Conectar</button>
    <button id="disconnectBtn">Desconectar</button>

    <hr>

    <button id="toggleMode">Ativar controle por movimento</button>

    <div id="pad">Toque aqui para mover o mouse</div>

    <div class="btns">
      <button id="leftBtn">üñ±Ô∏è Clique Esquerdo</button>
      <button id="rightBtn">üñ±Ô∏è Clique Direito</button>
      <button id="kbBtn">‚å®Ô∏è Teclado</button>
    </div>

    <div id="keyboard" style="display:none;">
      <input type="text" id="textToType" placeholder="Digite algo...">
      <button id="sendText">Enviar</button>
    </div>
  </div>

<script>
(function(){
  let ws = null;
  let lastTouch = null;
  let lastSingleTap = 0;
  let isScrolling = false;
  let sensitivity = 1.0;
  let gyroEnabled = false;
  let moved = false;

  // --- Vari√°veis do aceler√¥metro ---
  let accelListener = null;
  let lastAX = null;
  let lastAY = null;

  // Ajuste fino
  let accelFactor = 4.5;
  let minDelta = 0.08;

  const statusEl = document.getElementById('status');
  const wsUrlInput = document.getElementById('wsUrl');
  const tokenInput = document.getElementById('token');
  const connectBtn = document.getElementById('connectBtn');
  const disconnectBtn = document.getElementById('disconnectBtn');
  const pad = document.getElementById('pad');
  const leftBtn = document.getElementById('leftBtn');
  const rightBtn = document.getElementById('rightBtn');
  const kbBtn = document.getElementById('kbBtn');
  const keyboardDiv = document.getElementById('keyboard');
  const textToType = document.getElementById('textToType');
  const sendText = document.getElementById('sendText');
  const toggleMode = document.getElementById('toggleMode');

  function setStatus(s,color='#0b5'){
    statusEl.textContent = s;
    statusEl.style.background = color;
  }

  function connect(){
    let url = wsUrlInput.value.trim();
    const token = tokenInput.value.trim();
    if(!url || !token) return alert("Informe endere√ßo e token!");

    // Ajusta WS/WSS autom√°tico
    if(location.protocol === "https:" && url.startsWith("ws://")){
      url = url.replace("ws://","wss://");
    }

    ws = new WebSocket(url);

    ws.onopen = () => {
      ws.send(JSON.stringify({type:"auth", token}));
      setStatus("Conectado a " + url, "#054");
    };
    ws.onclose = () => setStatus("Desconectado", "#a00");
    ws.onerror = () => setStatus("Erro de conex√£o", "#a00");
    ws.onmessage = msg => {
      try{
        const data = JSON.parse(msg.data);
        if(data.type==='auth' && data.status==='ok'){
          setStatus("Autenticado ‚úî", "#0a4");
        } else if(data.type==='auth'){
          setStatus("Token inv√°lido ‚ùå", "#a00");
          ws.close();
        }
      }catch(e){}
    };
  }

  function disconnect(){
    if(ws){
      try{
        if(ws.readyState === WebSocket.OPEN){
          ws.send(JSON.stringify({type:"disconnect"}));
        }
      }catch(e){}
      disableMotion();
      ws.close();
    }
    ws = null;
    setStatus("Desconectado", "#a00");
  }

  connectBtn.addEventListener('click', connect);
  disconnectBtn.addEventListener('click', disconnect);

  function send(obj){
    if(!ws || ws.readyState !== WebSocket.OPEN) return;
    ws.send(JSON.stringify(obj));
  }

  // ============================================================
  // ACELER√îMETRO / GIROSC√ìPIO
  // ============================================================
  async function enableMotion(){
    if(gyroEnabled) return;
    if(typeof DeviceMotionEvent === 'undefined'){
      alert("Seu dispositivo n√£o suporta sensores de movimento.");
      return;
    }

    try{
      if(typeof DeviceMotionEvent.requestPermission === "function"){
        const perm = await DeviceMotionEvent.requestPermission();
        if(perm !== "granted"){
          alert("Permiss√£o negada!");
          return;
        }
      }
    }catch(e){
      alert("Erro ao solicitar permiss√£o.");
      return;
    }

    startAccelerometer();
  }

  function startAccelerometer(){
    gyroEnabled = true;
    toggleMode.classList.add("active");
    toggleMode.textContent = "Desativar controle por movimento";
    pad.style.opacity = "0.5";

    lastAX = null;
    lastAY = null;

    accelListener = e =>{
      if(!gyroEnabled || !ws || ws.readyState !== WebSocket.OPEN) return;
      const acc = e.accelerationIncludingGravity;
      if(!acc) return;

      let ax = acc.x, ay = acc.y;

      if(lastAX === null){
        lastAX = ax; lastAY = ay; return;
      }

      let dx = ax - lastAX;
      let dy = ay - lastAY;

      lastAX = ax; lastAY = ay;

      if(Math.abs(dx) < minDelta) dx = 0;
      if(Math.abs(dy) < minDelta) dy = 0;
      if(dx === 0 && dy === 0) return;

      dx *= accelFactor;
      dy *= accelFactor;

      // Suaviza movimentos bruscos
      dx = Math.sign(dx) * Math.min(Math.abs(dx), 15);
      dy = Math.sign(dy) * Math.min(Math.abs(dy), 15);

      send({type:"gyro", dx, dy});
    };

    window.addEventListener("devicemotion", accelListener);
  }

  function disableMotion(){
    gyroEnabled = false;
    toggleMode.classList.remove("active");
    toggleMode.textContent = "Ativar controle por movimento";
    pad.style.opacity = "1";
    if(accelListener) window.removeEventListener("devicemotion", accelListener);
  }

  toggleMode.addEventListener('click', ()=>{
    if(!ws || ws.readyState !== WebSocket.OPEN){ alert("Conecte-se primeiro."); return; }
    if(gyroEnabled) disableMotion(); else enableMotion();
  });

  // ============================================================
  // TOUCHPAD
  // ============================================================
  pad.addEventListener('touchstart', e =>{
    if(gyroEnabled) return; e.preventDefault(); moved=false;
    const t = e.touches[0]; lastTouch={x:t.clientX,y:t.clientY};
    isScrolling = e.touches.length>=2;
  }, {passive:false});

  pad.addEventListener('touchmove', e =>{
    if(gyroEnabled) return; e.preventDefault(); moved=true;
    const touches = e.touches;

    if(isScrolling && touches.length>=2){
      const cx=(touches[0].clientX+touches[1].clientX)/2;
      const cy=(touches[0].clientY+touches[1].clientY)/2;
      const dy=cy-lastTouch.y; lastTouch={x:cx,y:cy};
      send({type:'scroll', dx:0, dy:-Math.round(dy*0.2)}); return;
    }

    const t = touches[0];
    const dx = t.clientX - lastTouch.x;
    const dy = t.clientY - lastTouch.y;
    lastTouch={x:t.clientX,y:t.clientY};
    send({type:'move', dx:Math.round(dx), dy:Math.round(dy), sensitivity});
  }, {passive:false});

  pad.addEventListener('touchend', e =>{
    if(gyroEnabled) return; e.preventDefault();
    if(moved) return;
    const now=Date.now();
    if(now-lastSingleTap<300){ send({type:'click', button:'left', clicks:2}); lastSingleTap=0; }
    else{ send({type:'click', button:'left', clicks:1}); lastSingleTap=now; }
  }, {passive:false});

  leftBtn.addEventListener('click', ()=>send({type:'click', button:'left'}));
  rightBtn.addEventListener('click', ()=>send({type:'click', button:'right'}));

  kbBtn.addEventListener('click', ()=>{
    const v = keyboardDiv.style.display==='flex';
    keyboardDiv.style.display=v?'none':'flex';
    if(!v) setTimeout(()=>textToType.focus(),120);
  });

  sendText.addEventListener('click', ()=>{
    const txt=textToType.value; if(!txt) return;
    send({type:'type', text:txt}); textToType.value='';
  });
})();
</script>


</body>
</html>
